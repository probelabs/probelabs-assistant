version: "1.0"

id: twitter
name: Twitter/X API

# Reusable workflow: twitter
#
# Goal:
#   Interact with the Twitter/X API v2 â€” read tweets, search, get bookmarks,
#   and fetch user timelines. Uses a Python helper script that calls the API
#   directly with no external dependencies.
#
# Input contract:
#   - inputs.action: string (required) - One of: read_tweet, search, bookmarks, user_tweets
#   - inputs.query: string (required for read_tweet/search/user_tweets)
#   - inputs.max_results: number (optional, 10-100, default 10)
#
# Output contract:
#   - result: object - JSON response from Twitter API
#
# Environment:
#   Credentials are loaded from .env by the Python script itself (auto-discovery).
#   No env vars need to be passed explicitly.

inputs:
  - name: action
    required: true
    description: "The action to perform: read_tweet, search, bookmarks, user_tweets"
    schema:
      type: string
      enum: [read_tweet, search, bookmarks, user_tweets]

  - name: query
    required: false
    description: "Tweet URL or ID (for read_tweet), search query (for search), or username (for user_tweets)"
    default: ""
    schema:
      type: string

  - name: max_results
    required: false
    description: "Number of results to return (10-100, only for search/bookmarks/user_tweets)"
    default: 10
    schema:
      type: number
      minimum: 10
      maximum: 100

outputs:
  - name: result
    value_js: |
      const step = outputs?.['twitter-request'];
      if (!step) return null;
      if (typeof step === 'string') {
        try { return JSON.parse(step); } catch(e) { return { text: step }; }
      }
      if (step?.stdout) {
        try { return JSON.parse(step.stdout); } catch(e) { return { text: step.stdout }; }
      }
      if (step?.text) return step;
      return step;

steps:
  build-twitter-command:
    type: script
    criticality: internal
    schema:
      type: object
      properties:
        command:
          type: string
    assume:
      - "true"
    fanout: reduce
    content: |
      const action = inputs.action ?? '';
      const query = inputs.query ?? '';
      const maxResults = inputs.max_results ?? 10;

      // Resolve script path: try VISOR_ORIGINAL_WORKDIR first (set by visor
      // when workspace isolation is on), then fall back to CWD
      const baseDir = (typeof env !== 'undefined' && env.VISOR_ORIGINAL_WORKDIR)
        ? env.VISOR_ORIGINAL_WORKDIR
        : '.';
      const scriptPath = baseDir + '/scripts/twitter-api.py';

      // Build args with proper shell escaping
      const safeQuery = query.replace(/'/g, "'\\''");
      const args = [action];
      if (query) {
        args.push("'" + safeQuery + "'");
      }
      if (['search', 'bookmarks', 'user_tweets'].includes(action) && maxResults) {
        args.push('--max_results=' + Math.max(10, Math.min(100, maxResults)));
      }

      const command = 'python3 ' + scriptPath + ' ' + args.join(' ');
      return { command };

  twitter-request:
    type: command
    criticality: policy
    depends_on: [build-twitter-command]
    assume:
      - "outputs['build-twitter-command'] != null"
    guarantee: "output != null"
    timeout: 30000
    exec: "{{ outputs['build-twitter-command'].command }}"
    transform_js: |
      if (typeof output === 'string') {
        try { return JSON.parse(output); } catch(e) { return { text: output }; }
      }
      if (output?.stdout) {
        try { return JSON.parse(output.stdout); } catch(e) { return { text: output.stdout }; }
      }
      return output;

tests:
  defaults:
    strict: true
    ai_provider: mock

  cases:
    - name: read-tweet-builds-correct-command
      event: manual
      fixture: local.minimal
      workflow_input:
        action: "read_tweet"
        query: "https://x.com/user/status/123456"
      mocks:
        twitter-request: '{"id":"123456","text":"Hello world","author":"@user (User)"}'
      expect:
        calls:
          - step: build-twitter-command
            exactly: 1
          - step: twitter-request
            exactly: 1
        workflow_output:
          - path: result.id
            equals: "123456"
          - path: result.text
            equals: "Hello world"

    - name: search-builds-correct-command
      event: manual
      fixture: local.minimal
      workflow_input:
        action: "search"
        query: "claude code"
        max_results: 20
      mocks:
        twitter-request: '{"query":"claude code","count":10,"tweets":[]}'
      expect:
        calls:
          - step: build-twitter-command
            exactly: 1
          - step: twitter-request
            exactly: 1
        workflow_output:
          - path: result.query
            equals: "claude code"

    - name: bookmarks-builds-correct-command
      event: manual
      fixture: local.minimal
      workflow_input:
        action: "bookmarks"
      mocks:
        twitter-request: '{"bookmarks_count":5,"bookmarks":[{"id":"1","text":"saved tweet"}]}'
      expect:
        calls:
          - step: build-twitter-command
            exactly: 1
          - step: twitter-request
            exactly: 1
        workflow_output:
          - path: result.bookmarks_count
            equals: 5

    - name: user-tweets-builds-correct-command
      event: manual
      fixture: local.minimal
      workflow_input:
        action: "user_tweets"
        query: "buger"
        max_results: 15
      mocks:
        twitter-request: '{"user":"@buger (Leonid Bugaev)","count":10,"tweets":[]}'
      expect:
        calls:
          - step: build-twitter-command
            exactly: 1
          - step: twitter-request
            exactly: 1
        workflow_output:
          - path: result.user
            contains: "buger"
