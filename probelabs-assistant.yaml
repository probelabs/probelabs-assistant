# =============================================================================
# ProbeLabs Assistant - Unified Skills Architecture
# =============================================================================
#
# AI assistant for ProbeLabs, helping developers explore and work with
# the ProbeLabs product ecosystem: Probe, Visor, GoReplay, and developer tools.
#
# Based on the Visor-EE workflow engine with unified skills.
#
# Configuration files:
#   - config/intents.yaml   - Intent definitions (high-level routing)
#   - config/skills.yaml    - Unified skills (knowledge, servers, code_config with projects)
#
# =============================================================================

version: "1.0"

# Import the high-level assistant workflow from visor-ee
imports:
  - https://raw.githubusercontent.com/probelabs/visor-ee/master/workflows/assistant.yaml
  - workflows/engineer.yaml

workspace:
  enabled: true
  cleanup_on_exit: true

slack:
  version: "v1"
  mentions: all
  threads: required
  show_raw_output: true
  allow_bot_messages: true
  telemetry:
    enabled: true

scheduler:
  enabled: true
  storage:
    path: .visor/schedules.json
  default_timezone: UTC
  limits:
    max_per_user: 25
    max_recurring_per_user: 10
    max_global: 1000
  permissions:
    allow_personal: true
    allow_channel: true
    allow_dm: true

checks:
  chat:
    type: workflow
    criticality: policy
    workflow: assistant
    assume:
      - "conversation.current.text != null"
    guarantee: "output?.text != null"
    args:
      question: "{{ conversation.current.text }}"

      system_prompt: |
        You are the ProbeLabs AI Assistant, helping developers explore and work with
        ProbeLabs products: Probe (semantic code search), Visor (AI code review),
        GoReplay (HTTP traffic replay), and the suite of AI developer tools.

      # Intent definitions (high-level routing)
      intents:
        expression: "loadConfig('config/intents.yaml')"

      # Unified skills
      skills:
        expression: "loadConfig('config/skills.yaml')"

# =============================================================================
# Tests
# =============================================================================
tests:
  defaults:
    strict: true
    ai_provider: mock

  cases:
    - name: github-skill-activation
      description: GitHub skill activates for repo browsing requests
      flow:
        - name: github-flow
          event: manual
          fixture: local.minimal
          routing:
            max_loops: 0
          execution_context:
            conversation:
              transport: slack
              thread: { id: "test-1" }
              messages: [{ role: user, text: "Show me recent PRs on probe", timestamp: "2024-01-01T00:00:00Z" }]
              current: { role: user, text: "Show me recent PRs on probe", timestamp: "2024-01-01T00:00:00Z" }
              attributes: { channel: "C123", user: "U456" }
          mocks:
            chat[]:
              - text: "Here are the recent PRs for probelabs/probe..."
              - intent: chat
              - skills: [github]
          expect:
            calls:
              - step: chat
                exactly: 1

    - name: code-explorer-skill-activation
      description: Code explorer activates for code questions
      flow:
        - name: code-flow
          event: manual
          fixture: local.minimal
          routing:
            max_loops: 0
          execution_context:
            conversation:
              transport: slack
              thread: { id: "test-2" }
              messages: [{ role: user, text: "How does Probe's tree-sitter integration work?", timestamp: "2024-01-01T00:00:00Z" }]
              current: { role: user, text: "How does Probe's tree-sitter integration work?", timestamp: "2024-01-01T00:00:00Z" }
              attributes: { channel: "C123", user: "U456" }
          mocks:
            chat[]:
              - text: "Probe uses tree-sitter for AST-aware code extraction..."
              - intent: code_help
              - skills: [code-explorer]
          expect:
            calls:
              - step: chat
                exactly: 1
